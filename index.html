<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ö–∞–ª–µ–Ω–¥–∞—Ä—å –≤—Å—Ç—Ä–µ—á</title>

  <!-- Firebase -->
  <script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics.js";

    // Firebase configuration
    const firebaseConfig = { 
      apiKey: "AIzaSyAWzacAewH_nRxNJRqnrORF9vPhzaLjn-Q",
      authDomain: "meeting-calendar-20eb2.firebaseapp.com",
      projectId: "meeting-calendar-20eb2",
      storageBucket: "meeting-calendar-20eb2.firebasestorage.app",
      messagingSenderId: "43144949492",
      appId: "1:43144949492:web:afd82bd90b4ae3e637f8a1",
      measurementId: "G-V5LDJRR90J"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getDatabase();

    // ---------------- Variables ----------------
    let meetings = [];
    let currentWeekOffset = 0;
    let selectedTime = null;

    const timeSlots = [
      '09:00','09:30','10:00','10:30','11:00','11:30',
      '12:00','12:30','13:00','13:30','14:00','14:30',
      '15:00','15:30','16:00','16:30','17:00','17:30','18:00'
    ];

    // ---------------- Functions ----------------
    window.initTimeGrid = function() {
      const grid = document.getElementById('timeGrid');
      grid.innerHTML = '';
      timeSlots.forEach(time => {
        const slot = document.createElement('div');
        slot.className = 'time-slot';
        slot.textContent = time;
        slot.onclick = () => selectTime(time, slot);
        grid.appendChild(slot);
      });
    }

    window.selectTime = function(time, element) {
      if (element.classList.contains('occupied')) return;
      document.querySelectorAll('.time-slot').forEach(el => el.classList.remove('selected'));
      element.classList.add('selected');
      selectedTime = time;
    }

    window.updateTimeSlots = function() {
      const dateInput = document.getElementById('meetingDate');
      const selectedDate = dateInput.value;
      if (!selectedDate) return;

      const occupiedTimes = meetings.filter(m => m.date === selectedDate).map(m => m.time);

      document.querySelectorAll('.time-slot').forEach(slot => {
        const time = slot.textContent;
        slot.classList.remove('occupied', 'selected');
        if (occupiedTimes.includes(time)) slot.classList.add('occupied');
      });

      selectedTime = null;
    }

    window.addMeeting = function() {
      const date = document.getElementById('meetingDate').value;
      const company = document.getElementById('companyName').value;
      const contact = document.getElementById('contactPerson').value;
      const phone = document.getElementById('phone').value;
      const address = document.getElementById('address').value;
      const comment = document.getElementById('comment').value;

      if (!date || !selectedTime || !company) {
        alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: –¥–∞—Ç–∞, –≤—Ä–µ–º—è –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏');
        return;
      }

      const newMeetingRef = push(ref(db, 'meetings'));
      set(newMeetingRef, {
        id: newMeetingRef.key,
        date,
        time: selectedTime,
        company,
        contact,
        phone,
        address,
        comment
      });

      document.getElementById('companyName').value = '';
      document.getElementById('contactPerson').value = '';
      document.getElementById('phone').value = '';
      document.getElementById('address').value = '';
      document.getElementById('comment').value = '';
      selectedTime = null;
    }

    window.deleteMeeting = function(id) {
      if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –≤—Å—Ç—Ä–µ—á—É?')) {
        remove(ref(db, 'meetings/' + id));
      }
    }

    function getWeekDates(offset) {
      const today = new Date();
      today.setDate(today.getDate() + offset * 7);
      const firstDay = new Date(today);
      const day = firstDay.getDay();
      const diff = firstDay.getDate() - day + (day === 0 ? -6 : 1);
      firstDay.setDate(diff);
      const dates = [];
      for(let i=0;i<7;i++){
        const d = new Date(firstDay);
        d.setDate(firstDay.getDate()+i);
        dates.push(d);
      }
      return dates;
    }

    function formatDate(date) {
      return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
    }

    function formatDisplayDate(date){
      const days = ['–í—Å','–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±'];
      const months = ['—è–Ω–≤','—Ñ–µ–≤','–º–∞—Ä','–∞–ø—Ä','–º–∞—è','–∏—é–Ω','–∏—é–ª','–∞–≤–≥','—Å–µ–Ω','–æ–∫—Ç','–Ω–æ—è','–¥–µ–∫'];
      return `${days[date.getDay()]}, ${date.getDate()} ${months[date.getMonth()]}`;
    }

    function updateCalendar() {
      const dates = getWeekDates(currentWeekOffset);
      const grid = document.getElementById('calendarGrid');
      grid.innerHTML = '';

      const firstDate = dates[0];
      const lastDate = dates[6];
      document.getElementById('currentWeek').textContent =
        `${firstDate.getDate()} ${['—è–Ω–≤','—Ñ–µ–≤','–º–∞—Ä','–∞–ø—Ä','–º–∞—è','–∏—é–Ω','–∏—é–ª','–∞–≤–≥','—Å–µ–Ω','–æ–∫—Ç','–Ω–æ—è','–¥–µ–∫'][firstDate.getMonth()]} - ${lastDate.getDate()} ${['—è–Ω–≤','—Ñ–µ–≤','–º–∞—Ä','–∞–ø—Ä','–º–∞—è','–∏—é–Ω','–∏—é–ª','–∞–≤–≥','—Å–µ–Ω','–æ–∫—Ç','–Ω–æ—è','–¥–µ–∫'][lastDate.getMonth()]} ${lastDate.getFullYear()}`;

      dates.forEach(date=>{
        const dateStr = formatDate(date);
        const dayMeetings = meetings.filter(m=>m.date===dateStr).sort((a,b)=>a.time.localeCompare(b.time));
        const card = document.createElement('div');
        card.className = 'day-card';
        const todayStr = formatDate(new Date());
        const isToday = dateStr===todayStr;

        card.innerHTML = `
          <div class="day-header">
            <div class="day-name" style="${isToday?'color:#ef5350;':''}">${formatDisplayDate(date)} ${isToday?'(–°–µ–≥–æ–¥–Ω—è)':''}</div>
            <div class="day-date">${dayMeetings.length} –≤—Å—Ç—Ä–µ—á</div>
          </div>
          <div class="meetings-list">
            ${dayMeetings.length>0 ? 
              dayMeetings.map(m=>`
                <div class="meeting-card">
                  <div class="meeting-time">‚è∞ ${m.time}</div>
                  <div class="meeting-company">üè¢ ${m.company}</div>
                  ${m.contact?`<div class="meeting-contact">üë§ ${m.contact}</div>`:''}
                  ${m.phone?`<div class="meeting-contact">üìû ${m.phone}</div>`:''}
                  ${m.address?`<div class="meeting-contact">üìç ${m.address}</div>`:''}
                  ${m.comment?`<div class="meeting-contact">üí¨ ${m.comment}</div>`:''}
                  <div class="meeting-actions">
                    <button class="delete-btn" onclick="deleteMeeting('${m.id}')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                  </div>
                </div>
              `).join('') : '<div class="no-meetings">–í—Å—Ç—Ä–µ—á –Ω–µ—Ç</div>'}
          </div>
        `;
        grid.appendChild(card);
      });
    }

    window.changeWeek = function(offset){
      currentWeekOffset = offset===0?0:currentWeekOffset+offset;
      updateCalendar();
    }

    function updateStats(){
      const todayStr = formatDate(new Date());
      const todayMeetings = meetings.filter(m=>m.date===todayStr).length;
      const weekDates = getWeekDates(0).map(d=>formatDate(d));
      const weekMeetings = meetings.filter(m=>weekDates.includes(m.date)).length;

      document.getElementById('todayCount').textContent = todayMeetings;
      document.getElementById('weekCount').textContent = weekMeetings;
      document.getElementById('totalCount').textContent = meetings.length;
    }

    function updateAll() {
      updateCalendar();
      updateTimeSlots();
      updateStats();
    }

    // ---------------- Listen Firebase ----------------
    const meetingsRef = ref(db, 'meetings');
    onValue(meetingsRef, (snapshot)=>{
      const data = snapshot.val();
      meetings = data ? Object.values(data) : [];
      updateAll();
    });

    // ---------------- Initialize ----------------
    window.addEventListener('DOMContentLoaded', ()=>{
      const today = new Date();
      document.getElementById('meetingDate').value = formatDate(today);
      document.getElementById('meetingDate').min = formatDate(today);
      initTimeGrid();
    });
  </script>

  <style>
    /* —Å—é–¥–∞ –≤—Å—Ç–∞–≤–ª—è–µ–º CSS –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞ */
    /* ... */
  </style>
</head>
<body>
  <!-- HTML —Å—Ç—Ä—É–∫—Ç—É—Ä–∞: —Ñ–æ—Ä–º–∞ –∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—å -->
  <div class="container">
    <div class="header">
      <h1>üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å –≤—Å—Ç—Ä–µ—á –∫–æ–ª–ª-—Ü–µ–Ω—Ç—Ä–∞</h1>
      <p>–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∏–∑–∏—Ç–æ–≤ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è —Å—Ç–æ–ª–µ—à–Ω–∏—Ü</p>
    </div>
    <div class="content">
      <div class="form-section">
        <h2 style="margin-bottom: 20px; color: #333;">–ù–æ–≤–∞—è –≤—Å—Ç—Ä–µ—á–∞</h2>
        <div class="form-group">
          <label>üìÖ –î–∞—Ç–∞ –≤—Å—Ç—Ä–µ—á–∏</label>
          <input type="date" id="meetingDate" required>
        </div>
        <div class="form-group">
          <label>üïê –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è</label>
          <div class="time-grid" id="timeGrid"></div>
        </div>
        <div class="form-group">
          <label>üè¢ –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏</label>
          <input type="text" id="companyName" placeholder="–ö—É—Ö–Ω–∏ –õ—é–∫—Å" required>
        </div>
        <div class="form-group">
          <label>üë§ –ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ</label>
          <input type="text" id="contactPerson" placeholder="–ò–≤–∞–Ω–æ–≤ –ü–µ—Ç—Ä (–¥–∏—Ä–µ–∫—Ç–æ—Ä)">
        </div>
        <div class="form-group">
          <label>üìû –¢–µ–ª–µ—Ñ–æ–Ω</label>
          <input type="tel" id="phone" placeholder="+7 (999) 123-45-67">
        </div>
        <div class="form-group">
          <label>üìç –ê–¥—Ä–µ—Å</label>
          <input type="text" id="address" placeholder="—É–ª. –õ–µ–Ω–∏–Ω–∞, 15">
        </div>
        <div class="form-group">
          <label>üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
          <textarea id="comment" placeholder="–ò–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç —Ç–µ–º–Ω—ã–π –∫–∞–º–µ–Ω—å, —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ó–æ–≤..."></textarea>
        </div>
        <button class="btn" onclick="addMeeting()">‚úÖ –î–æ–±–∞–≤–∏—Ç—å –≤—Å—Ç—Ä–µ—á—É</button>
      </div>
      <div class="calendar-section">
        <div class="stats">
          <div class="stat-card">
            <div class="stat-number" id="todayCount">0</div>
            <div class="stat-label">–í—Å—Ç—Ä–µ—á —Å–µ–≥–æ–¥–Ω—è</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="weekCount">0</div>
            <div class="stat-label">–ù–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="totalCount">0</div>
            <div class="stat-label">–í—Å–µ–≥–æ –≤—Å—Ç—Ä–µ—á</div>
          </div>
        </div>
        <div class="calendar-header">
          <div class="calendar-nav">
            <button class="nav-btn" onclick="changeWeek(-1)">‚Üê –ü—Ä–µ–¥. –Ω–µ–¥–µ–ª—è</button>
            <button class="nav-btn" onclick="changeWeek(0)">–°–µ–≥–æ–¥–Ω—è</button>
            <button class="nav-btn" onclick="changeWeek(1)">–°–ª–µ–¥. –Ω–µ–¥–µ–ª—è ‚Üí</button>
          </div>
          <div class="current-date" id="currentWeek"></div>
        </div>
        <div class="calendar-grid" id="calendarGrid"></div>
      </div>
    </div>
  </div>
</body>
</html>
        loadMeetings();
        initTimeGrid();
        updateCalendar();
        updateTimeSlots();
        updateStats();
    </script>
</body>
</html>
